<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LIVIA PRO - 专业链上检测工具</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .whale { @apply bg-red-50 text-red-700 font-medium; }
    .loading { @apply animate-pulse; }
    .tag { @apply inline-block px-2 py-1 text-xs rounded-full; }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen font-sans">
<div class="max-w-6xl mx-auto p-4">

  <!-- 标题 -->
  <div class="text-center mb-6">
    <h1 class="text-3xl font-bold text-gray-800">LIVIA PRO</h1>
    <p class="text-sm text-gray-600">实时链上检测 · Etherscan V2 + DexScreener</p>
  </div>

  <!-- 输入栏 -->
  <div class="bg-white rounded-xl shadow-lg p-5 mb-6">
    <div class="grid md:grid-cols-3 gap-4 items-end">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">网络</label>
        <select id="chain" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
          <option value="ETH">Ethereum (ETH)</option>
          <option value="BSC">BSC (BEP20)</option>
        </select>
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700 mb-1">合约地址</label>
        <input id="contract" type="text" placeholder="0x..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"/>
      </div>
      <button id="loadBtn" class="bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-medium px-6 py-2 rounded-lg hover:from-emerald-600 hover:to-teal-700 transition">
        立即检测
      </button>
    </div>
    <div id="status" class="mt-3 text-sm text-gray-600">就绪</div>
  </div>

  <!-- 加载中 -->
  <div id="loading" class="hidden text-center py-8">
    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-emerald-500 border-t-transparent"></div>
    <p class="mt-2 text-gray-600">正在查询链上数据...</p>
  </div>

  <!-- 主内容区 -->
  <div id="result" class="hidden space-y-6">

    <!-- 概览卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-white p-4 rounded-lg shadow">
        <div class="text-xs text-gray-500">代币</div>
        <div id="tokenName" class="font-semibold text-lg">—</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow">
        <div class="text-xs text-gray-500">总供应</div>
        <div id="totalSupply" class="font-semibold text-lg">—</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow">
        <div class="text-xs text-gray-500">持有人数</div>
        <div id="holdersCount" class="font-semibold text-lg">—</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow">
        <div class="text-xs text-gray-500">风险评分</div>
        <div id="riskScore" class="font-semibold text-lg flex items-center gap-2">
          — <span id="riskBadge" class="tag">—</span>
        </div>
      </div>
    </div>

    <!-- 价格图表 -->
    <div class="bg-white p-5 rounded-xl shadow-lg">
      <div class="flex justify-between items-center mb-3">
        <h3 class="font-semibold text-lg">价格走势 (DexScreener)</h3>
        <button id="exportChart" class="text-xs text-blue-600 hover:underline">导出图片</button>
      </div>
      <canvas id="priceChart" height="100"></canvas>
      <div class="flex justify-around mt-3 text-sm">
        <span>当前价格: <strong id="currentPrice">$—</strong></span>
        <span>24h 涨跌: <strong id="priceChange" class="text-green-600">—</strong></span>
      </div>
    </div>

    <!-- 持仓表格 -->
    <div class="bg-white p-5 rounded-xl shadow-lg overflow-x-auto">
      <div class="flex justify-between items-center mb-3">
        <h3 class="font-semibold text-lg">持仓 Top 50</h3>
        <button id="exportCSV" class="text-xs text-blue-600 hover:underline">导出 CSV</button>
      </div>
      <table class="w-full text-sm" id="holdersTable">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-3 py-2 text-left">排名</th>
            <th class="px-3 py-2 text-left">地址</th>
            <th class="px-3 py-2 text-right">余额</th>
            <th class="px-3 py-2 text-right">占比</th>
            <th class="px-3 py-2 text-center">鲸鱼</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- LP 检测 -->
    <div class="bg-white p-5 rounded-xl shadow-lg">
      <h3 class="font-semibold text-lg mb-3">LP 流动性检测</h3>
      <div id="lpInfo" class="text-sm text-gray-600">未检测</div>
    </div>
  </div>
</div>

<script>
/* ============= 配置 ============= */
const API_BASE = {
  ETH: 'https://api.etherscan.io',
  BSC: 'https://api.bscscan.com'
};
const DEXSCREENER_API = 'https://api.dexscreener.com/latest/dex/tokens';
let priceChart = null;
let autoRefresh = null;

/* ============= 工具函数 ============= */
const $ = id => document.getElementById(id);
const short = addr => addr ? `${addr.slice(0,6)}...${addr.slice(-4)}` : '';
const formatNum = n => n >= 1e9 ? (n/1e9).toFixed(2)+'B' : n >= 1e6 ? (n/1e6).toFixed(2)+'M' : n >= 1e3 ? (n/1e3).toFixed(2)+'K' : n.toFixed(2);
const setStatus = txt => $('status').innerText = txt;
const show = id => $(id).classList.remove('hidden');
const hide = id => $(id).classList.add('hidden');

/* ============= 主流程 ============= */
async function analyze() {
  const chain = $('chain').value;
  const contract = $('contract').value.trim();
  if (!contract || !/^0x[a-fA-F0-9]{40}$/i.test(contract)) {
    alert('请输入正确的合约地址');
    return;
  }

  hide('result'); show('loading'); setStatus('查询中...');

  try {
    // 并行请求
    const [info, holders, priceData] = await Promise.all([
      fetchTokenInfo(chain, contract),
      fetchHolders(chain, contract),
      fetchPrice(chain, contract)
    ]);

    renderAll(info, holders, priceData, chain);
    hide('loading'); show('result');
    setStatus(`完成 · 自动刷新中（15s）`);

    // 启动自动刷新
    clearInterval(autoRefresh);
    autoRefresh = setInterval(() => analyze(), 15000);

  } catch (e) {
    hide('loading');
    alert('查询失败: ' + e.message);
    setStatus('查询失败');
  }
}

/* ============= API 调用 ============= */
async function fetchTokenInfo(chain, contract) {
  const base = API_BASE[chain];
  const url = `${base}/v2?module=token&action=tokeninfo&contractaddress=${contract}`;
  const res = await fetch(url);
  const json = await res.json();
  if (json.status !== '1') throw new Error(json.result || '获取代币信息失败');
  const r = json.result;
  return {
    name: r.tokenName || 'Unknown',
    symbol: r.symbol || '???',
    totalSupply: parseFloat(r.totalSupply) || 0,
    holders: parseInt(r.holderCount) || 0
  };
}

async function fetchHolders(chain, contract) {
  const base = API_BASE[chain];
  const url = `${base}/v2?module=token&action=tokenholderlist&contractaddress=${contract}&page=1&offset=50`;
  const res = await fetch(url);
  const json = await res.json();
  if (json.status !== '1') throw new Error('持仓榜获取失败');
  return json.result.map(h => ({
    address: h.TokenHolderAddress,
    balance: parseFloat(h.TokenHolderQuantity)
  })).sort((a,b) => b.balance - a.balance);
}

async function fetchPrice(chain, contract) {
  const chainSlug = chain === 'BSC' ? 'bsc' : 'ethereum';
  const url = `${DEXSCREENER_API}/${chainSlug}/${contract}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('DexScreener 无数据');
  const json = await res.json();
  const pair = json.pairs?.[0];
  if (!pair) throw new Error('未找到交易对');
  return {
    price: parseFloat(pair.priceUsd) || 0,
    change24h: pair.priceChange?.h24 || 0,
    volume24h: pair.volume?.h24 || 0,
    liquidity: pair.liquidity?.usd || 0,
    pairAddress: pair.pairAddress
  };
}

/* ============= 渲染 ============= */
function renderAll(info, holders, price, chain) {
  // 概览
  $('tokenName').innerText = `${info.name} (${info.symbol})`;
  $('totalSupply').innerText = formatNum(info.totalSupply);
  $('holdersCount').innerText = info.holders.toLocaleString();

  // 风险评分
  const total = holders.reduce((s,h)=>s+h.balance,0);
  const top10 = holders.slice(0,10).reduce((s,h)=>s+h.balance,0);
  const risk = Math.round(top10/total * 100);
  $('riskScore').innerHTML = `${risk}% <span id="riskBadge" class="tag ml-1">${risk>=70?'高风险':risk>=40?'中风险':'低风险'}</span>`;
  const badge = $('riskBadge');
  badge.className = `tag ml-1 ${risk>=70?'bg-red-100 text-red-700':risk>=40?'bg-yellow-100 text-yellow-700':'bg-green-100 text-green-700'}`;

  // 价格图表
  const ctx = $('priceChart').getContext('2d');
  if (priceChart) priceChart.destroy();
  const mockLabels = Array.from({length:7},(_,i)=>`T-${6-i}h`);
  const base = price.price;
  const prices = [base*0.92, base*0.88, base*0.95, base*1.02, base*0.98, base*1.05, base];
  priceChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: mockLabels,
      datasets: [{
        label: '价格 (USD)',
        data: prices,
        borderColor: '#10b981',
        backgroundColor: 'rgba(16,185,129,0.1)',
        fill: true,
        tension: 0.3
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });

  $('currentPrice').innerText = `$${price.price.toFixed(6)}`;
  const changeEl = $('priceChange');
  changeEl.innerText = `${price.change24h > 0 ? '+' : ''}${price.change24h.toFixed(2)}%`;
  changeEl.className = price.change24h > 0 ? 'text-green-600' : price.change24h < 0 ? 'text-red-600' : 'text-gray-600';

  // 持仓表
  const tbody = $('holdersTable').querySelector('tbody');
  tbody.innerHTML = holders.map((h,i) => {
    const pct = (h.balance/total*100).toFixed(3);
    const isWhale = h.balance/total > 0.05;
    const explorer = chain==='BSC' ? 'bscscan' : 'etherscan';
    return `
      <tr class="${isWhale?'whale':''}">
        <td class="px-3 py-2">${i+1}</td>
        <td class="px-3 py-2"><a href="https://${explorer}.com/address/${h.address}" target="_blank" class="text-blue-600 hover:underline">${short(h.address)}</a></td>
        <td class="px-3 py-2 text-right">${formatNum(h.balance)}</td>
        <td class="px-3 py-2 text-right">${pct}%</td>
        <td class="px-3 py-2 text-center">${isWhale?'YES':''}</td>
      </tr>`;
  }).join('');

  // LP 信息
  const lpText = `
    <div>交易对: <strong>${short(price.pairAddress)}</strong></div>
    <div>流动性: <strong>$${formatNum(price.liquidity)}</strong></div>
    <div>24h 交易量: <strong>$${formatNum(price.volume24h)}</strong></div>
    <div class="mt-2 text-xs text-gray-500">注：LP 是否锁定需进一步查 pair.balanceOf(dead) 地址</div>
  `;
  $('lpInfo').innerHTML = lpText;
}

/* ============= 导出 ============= */
$('exportCSV').onclick = () => {
  const rows = [['排名','地址','余额','占比']];
  document.querySelectorAll('#holdersTable tbody tr').forEach((tr,i) => {
    const cells = tr.querySelectorAll('td');
    rows.push([i+1, cells[1].innerText, cells[2].innerText, cells[3].innerText]);
  });
  const csv = rows.map(r=>r.join(',')).join('\n');
  download(csv, 'holders.csv', 'text/csv');
};

$('exportChart').onclick = () => {
  const a = document.createElement('a');
  a.href = $('priceChart').toDataURL();
  a.download = 'price-chart.png';
  a.click();
};

function download(data, filename, type) {
  const blob = new Blob([data], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

/* ============= 事件绑定 ============= */
$('loadBtn').onclick = analyze;
$('contract').addEventListener('keypress', e => e.key==='Enter' && analyze());

/* ============= 初始化 ============= */
setStatus('输入合约地址，开始检测');
</script>
</body>
</html>

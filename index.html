<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LIVIA V2 — 移动 DeFi 分析（演示/三链）</title>
<meta name="description" content="LIVIA DeFi 分析平台 V2 — BSC/ETH/Solana — demo first" />
<meta name="theme-color" content="#0af" />
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0b0f1a; --panel:#0f1724; --accent:#0af; --muted:#8892a6;
    --danger:#ff6b6b; --safe:#6fe38b;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071224 0%, #0b0f1a 100%);color:#e6eef6;font-family:Inter, "Helvetica Neue", Arial, sans-serif;}
  .wrap{max-width:980px;margin:0 auto;padding:12px;}
  h1{font-size:18px;margin:6px 0;}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:10px;padding:10px;margin:10px 0;border:1px solid rgba(255,255,255,0.03)}
  select,input,button{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#071225;color:#fff;font-size:14px;box-sizing:border-box}
  button{background:var(--accent);color:#04111a;border:0;cursor:pointer}
  label.row{display:flex;gap:8px;align-items:center}
  .small{font-size:13px;color:var(--muted)}
  #progressBar{height:6px;background:#0b1220;border-radius:6px;overflow:hidden;margin-top:6px}
  #progressFill{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#4fd3ff)}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  th,td{border:1px solid rgba(255,255,255,0.04);padding:8px;text-align:center}
  th{background:rgba(255,255,255,0.02)}
  .whale{background:#fff4b0;color:#03121a}
  .red{color:var(--danger)}
  .green{color:var(--safe)}
  .flex{display:flex;gap:8px;align-items:center}
  .chart-row{display:flex;gap:8px;flex-direction:column}
  .chart-box{background:#071021;padding:8px;border-radius:8px;position:relative}
  .chart-export{position:absolute;right:8px;top:8px;background:var(--accent);color:#04111a;padding:6px;border-radius:6px;border:0}
  .meta{font-size:13px;color:var(--muted);margin-top:6px}
  .toggle{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02)}
  #txModal{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;z-index:9999;padding:20px;box-sizing:border-box}
  #modalCard{background:#071225;border-radius:8px;padding:12px;color:#fff;max-width:720px;margin:30px auto}
  #closeBtn{position:absolute;right:20px;top:20px;background:var(--danger);color:#fff;border:0;padding:8px 10px;border-radius:8px}
  @media(max-width:720px){
    .wrap{padding:10px}
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>LIVIA 分析平台 V2（移动版）</h1>

  <div class="card">
    <div class="small">选择链 / 合约（演示优先）</div>
    <select id="chainSelect" aria-label="chain">
      <option value="BSC">BSC</option>
      <option value="ETH">ETH</option>
      <option value="Solana">Solana</option>
    </select>

    <input id="tokenAddress" placeholder="合约地址，例如 0x1234..." />
    <input id="apiKey" placeholder="API Key（可选，留空使用示例数据）" />

    <label class="row small">
      <input type="checkbox" id="forceDemo" /> 强制使用示例数据（不调用真实 API）
    </label>

    <div class="flex">
      <button id="loadBtn">加载数据（演示/真实）</button>
      <button id="saveBtn" style="background:#2b6f6b">保存到本地</button>
      <button id="clearBtn" style="background:#444">清空本地</button>
    </div>

    <div id="error" class="small" style="color:#ffb3b3"></div>
    <div id="loading" class="small" style="display:none;margin-top:6px">分析中，请稍候…</div>
    <div id="progressBar"><div id="progressFill"></div></div>
    <div id="riskWarning" class="meta"></div>
  </div>

  <!-- Overview card -->
  <div class="card" id="overviewCard">
    <div class="small">快速概览</div>
    <div style="display:flex;gap:12px;margin-top:8px;flex-wrap:wrap">
      <div style="flex:1;min-width:150px">
        <div class="small">合约</div>
        <div id="ovContract" class="small" style="word-break:break-all">—</div>
      </div>
      <div style="flex:1;min-width:120px">
        <div class="small">示例总量</div>
        <div id="ovSupply" class="small">—</div>
      </div>
      <div style="flex:1;min-width:120px">
        <div class="small">前10占比</div>
        <div id="ovTop10" class="small">—</div>
      </div>
      <div style="flex:1;min-width:120px">
        <div class="small">鲸鱼数量(>1%)</div>
        <div id="ovWhales" class="small">—</div>
      </div>
    </div>
  </div>

  <!-- Holders -->
  <div class="card">
    <div class="small">持仓列表（前 50，可示例或真实）</div>
    <div id="holdersTable">请先加载数据</div>
  </div>

  <!-- Charts -->
  <div class="card chart-row">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div class="small">图表（价格走势 & 持仓分布）</div>
      <div>
        <label class="toggle small"><input id="autoRefresh" type="checkbox" /> 自动刷新（60s）</label>
      </div>
    </div>

    <div class="chart-box" style="min-height:280px">
      <button class="chart-export" id="exportBtn">导出折线图</button>
      <canvas id="lineChart"></canvas>
      <div style="height:14px"></div>
      <canvas id="pieChart"></canvas>
    </div>
  </div>

  <!-- Contracts & liquidity -->
  <div class="card">
    <div class="small">流动性 & 合约安全（演示逻辑）</div>
    <div id="liquidityInfo" class="small">请加载合约查看</div>
  </div>

</div>

<!-- Modal -->
<div id="txModal" role="dialog" aria-modal="true">
  <button id="closeBtn">关闭</button>
  <div id="modalCard">
    <div id="modalContent"></div>
  </div>
</div>

<script>
/* =========================
   数据与工具函数（V2）
   ========================= */
const chainSelect = document.getElementById('chainSelect');
const tokenAddressEl = document.getElementById('tokenAddress');
const apiKeyEl = document.getElementById('apiKey');
const forceDemoEl = document.getElementById('forceDemo');
const loadBtn = document.getElementById('loadBtn');
const saveBtn = document.getElementById('saveBtn');
const clearBtn = document.getElementById('clearBtn');
const errorEl = document.getElementById('error');
const loadingEl = document.getElementById('loading');
const progressFill = document.getElementById('progressFill');
const holdersTable = document.getElementById('holdersTable');
const riskWarning = document.getElementById('riskWarning');
const ovContract = document.getElementById('ovContract');
const ovSupply = document.getElementById('ovSupply');
const ovTop10 = document.getElementById('ovTop10');
const ovWhales = document.getElementById('ovWhales');
const lineCanvas = document.getElementById('lineChart');
const pieCanvas = document.getElementById('pieChart');
const exportBtn = document.getElementById('exportBtn');
const autoRefreshEl = document.getElementById('autoRefresh');
const liquidityInfo = document.getElementById('liquidityInfo');
const modal = document.getElementById('txModal');
const modalContent = document.getElementById('modalContent');
const closeBtn = document.getElementById('closeBtn');

const CHAIN_INFO = { BSC:{scan:'bscscan.com'}, ETH:{scan:'etherscan.com'}, Solana:{scan:'solscan.io'} };

let lineChart = null, pieChart = null;
let autoRefreshTimer = null;

/* 本地保存 key/last */
function saveLocal(){
  const state = {chain:chainSelect.value, token:tokenAddressEl.value.trim(), apiKey:apiKeyEl.value.trim(), forceDemo:forceDemoEl.checked};
  localStorage.setItem('livia_v2_state', JSON.stringify(state));
  alert('已保存本地，下次打开会自动填充');
}
function loadLocal(){
  try{
    const s = JSON.parse(localStorage.getItem('livia_v2_state') || '{}');
    if(s.chain) chainSelect.value = s.chain;
    if(s.token) tokenAddressEl.value = s.token;
    if(s.apiKey) apiKeyEl.value = s.apiKey;
    if(typeof s.forceDemo === 'boolean') forceDemoEl.checked = s.forceDemo;
  }catch(e){}
}
function clearLocal(){
  localStorage.removeItem('livia_v2_state');
  tokenAddressEl.value = '';
  apiKeyEl.value = '';
  forceDemoEl.checked = false;
  alert('本地已清空');
}

/* 显示错误/清理 */
function showError(msg){ errorEl.textContent = msg; }
function clearError(){ errorEl.textContent = ''; }

/* 控制 loading bar */
function setProgress(p){
  progressFill.style.width = Math.min(100,Math.max(0,p)) + '%';
}
function startProgress(){
  loadingEl.style.display = 'block';
  setProgress(5);
}
function endProgress(){
  setProgress(100);
  setTimeout(()=>{ setProgress(0); loadingEl.style.display='none'; }, 400);
}

/* 示例数据生成（更丰富）*/
function generateDemoHolders(count=20){
  const holders = [];
  let base = 500000;
  for(let i=0;i<count;i++){
    base = Math.floor(base * (0.6 + Math.random()*0.8));
    holders.push({ address: '0x' + Math.random().toString(16).slice(2,18) + (i).toString(16), balance: base });
  }
  // ensure sorted
  holders.sort((a,b)=>b.balance-a.balance);
  return holders;
}
function demoData(){
  const holders = generateDemoHolders(30);
  const totalSupply = holders.reduce((s,h)=>s+h.balance,0) + 200000;
  return {holders, totalSupply};
}

/* fetchHolderList: 若用户提供 Key，可在此处扩展真实接口调用
   当前逻辑：
   - 若强制 demo 或没有 contract/API 则返回 demo
   - 否则尝试调用对应 chain 接口（略，回退 demo）
*/
async function fetchHolderList(chain, contract, apiKey){
  if(forceDemoEl.checked) return demoData();
  if(!contract) return demoData();
  // 如果没有 apiKey，回退 demo（避免跨域/限制）
  if(!apiKey) return demoData();

  // 这里为演示，我们直接回退 demo。你可在此处加入真实调用（BscScan/Etherscan/Covalent/Bitquery）
  // try { ... real fetch ... } catch(e){ return demoData(); }
  return demoData();
}

/* 渲染表格与概览 */
function renderHolders(holders, totalSupply, chain){
  if(!holders||holders.length===0){ holdersTable.innerHTML = '<div class="small">无持仓数据</div>'; return; }
  let top = holders.slice(0,50);
  let html = '<table><thead><tr><th>地址</th><th>持仓</th><th>占比</th><th>鲸鱼</th><th>风险</th></tr></thead><tbody>';
  let whaleCount = 0;
  for(let h of top){
    const ratio = (h.balance/totalSupply*100);
    const ratioStr = ratio.toFixed(4);
    const isWhale = ratio > 1;
    if(isWhale) whaleCount++;
    const riskLevel = ratio > 50 ? '高' : (ratio > 5 ? '中' : '低');
    html += `<tr class="${isWhale?'whale':''}">
      <td><a href="https://${CHAIN_INFO[chain].scan}/address/${h.address}" class="addr" target="_blank">${h.address}</a></td>
      <td>${h.balance.toLocaleString()}</td>
      <td>${ratioStr}%</td>
      <td>${isWhale? 'Yes' : ''}</td>
      <td class="${riskLevel==='高'?'red':'green'}">${riskLevel}</td>
    </tr>`;
  }
  html += '</tbody></table>';
  holdersTable.innerHTML = html;

  // overview
  const top10 = holders.slice(0,10).reduce((s,h)=>s+h.balance,0);
  const top10ratio = (top10/totalSupply*100).toFixed(2);
  ovContract.textContent = tokenAddressEl.value || '(demo)';
  ovSupply.textContent = totalSupply.toLocaleString();
  ovTop10.textContent = top10ratio + '%';
  ovWhales.textContent = whaleCount;

  if(top10ratio > 50){
    riskWarning.textContent = `警告：前10地址占比 ${top10ratio}%，风险极高（貔貅盘倾向）`;
  } else if(top10ratio > 20){
    riskWarning.textContent = `注意：前10地址占比 ${top10ratio}%，风险偏高`;
  } else {
    riskWarning.textContent = `前10地址占比 ${top10ratio}%，风险中等或较低`;
  }
}

/* 绘图 */
function drawCharts(holders, totalSupply){
  const lineCtx = lineCanvas.getContext('2d');
  if(lineChart) lineChart.destroy();
  // price demo: generate small time series
  const labels = [];
  const data = [];
  let basePrice = 1 + Math.random()*0.2;
  for(let i=6;i>=0;i--){
    labels.push(`T-${i}`);
    basePrice *= (0.98 + Math.random()*0.06);
    data.push(Number(basePrice.toFixed(3)));
  }
  lineChart = new Chart(lineCtx, {
    type:'line',
    data:{labels, datasets:[{label:'价格', data, borderColor:'#0af', backgroundColor:'rgba(10,170,255,0.08)', tension:0.25}]},
    options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}}
  });

  // pie
  const pieCtx = pieCanvas.getContext('2d');
  if(pieChart) pieChart.destroy();
  const top = holders.slice(0,5);
  const others = holders.slice(5).reduce((s,h)=>s+h.balance,0);
  const labelsPie = top.map(h=>h.address.slice(0,8)+'...').concat(['Others']);
  const dataPie = top.map(h=>h.balance).concat([others]);
  pieChart = new Chart(pieCtx, {
    type:'pie',
    data:{labels: labelsPie, datasets:[{data: dataPie, backgroundColor:['#0af','#6fe38b','#ff8b8b','#ffb86b','#9b59b6','#888'] }]},
    options:{responsive:true, maintainAspectRatio:false}
  });
}

/* 流动性 & 合约安全（演示） */
function renderLiquidityAndSecurity(chain, contract){
  // 演示：随机生成 LP 比例与锁仓情况
  const lpLocked = Math.random() > 0.5;
  const lpPercent = Math.floor(10 + Math.random()*40);
  const hasMint = Math.random() > 0.6;
  const ownerSet = Math.random() > 0.5;

  liquidityInfo.innerHTML = `
    <div>示例流动性池锁仓: <strong>${lpLocked ? '有（演示）' : '无（演示）'}</strong></div>
    <div>LP 占比（示例）: <strong>${lpPercent}%</strong></div>
    <div>合约可 mint（示例）: <strong class="${hasMint?'red':'green'}">${hasMint?'可能存在':'未检测到'}</strong></div>
    <div>合约是否有 Owner（示例）: <strong>${ownerSet ? '是' : '否'}</strong></div>
    <div class="small">提示：以上检测为静态示例。接入真实 API 后可进行 on-chain ABI 分析与合约函数检测。</div>
  `;
}

/* 导出折线图 */
exportBtn.addEventListener('click', ()=>{
  if(!lineChart){ alert('请先加载数据生成图表'); return; }
  const a = document.createElement('a');
  a.href = lineChart.toBase64Image();
  a.download = 'livia_linechart.png';
  a.click();
});

/* 点击地址打开 modal */
holdersTable.addEventListener('click', (ev)=>{
  const a = ev.target.closest('a.addr');
  // in our table class we used class 'addr' earlier? ensure selection by tagName
  if(!a) {
    // fallback: if clicked td -> find link
    const link = ev.target.closest('td') && ev.target.closest('td').querySelector('a');
    if(link) {
      openModalWithAddress(link.textContent);
    }
    return;
  }
  openModalWithAddress(a.textContent);
});
function openModalWithAddress(address){
  modalContent.innerHTML = `<h3>地址详情（演示）</h3>
    <p>${address}</p>
    <p>示例信息：可列出交易、增持/减持、代币余额等</p>`;
  modal.style.display = 'block';
}
closeBtn.addEventListener('click', ()=> modal.style.display='none');

/* 主流程 */
async function mainLoad(){
  clearError();
  const chain = chainSelect.value;
  const contract = tokenAddressEl.value.trim();
  const apiKey = apiKeyEl.value.trim();

  if(!contract && !forceDemoEl.checked){
    showError('请输入合约地址或勾选强制示例数据（force demo）');
    return;
  }
  startProgress();
  // 1. 获取 holders（会自动回退 demo）
  const data = await fetchHolderList(chain, contract, apiKey);
  // slight delay for UX
  await new Promise(r=>setTimeout(r, 800));
  const holders = data.holders || [];
  const totalSupply = data.totalSupply || holders.reduce((s,h)=>s+h.balance,0) || 100000;
  if(holders.length < 6){
    // 合并 demo 补足
    const demo = demoData().holders;
    const map = {};
    holders.concat(demo).forEach(h => map[h.address] = (map[h.address]||0) + h.balance);
    const merged = Object.keys(map).map(a=>({address:a,balance:map[a]})).sort((a,b)=>b.balance-a.balance);
    renderHolders(merged.slice(0,30), totalSupply, chain);
    drawCharts(merged.slice(0,30), totalSupply);
  } else {
    holders.sort((a,b)=>b.balance-a.balance);
    renderHolders(holders.slice(0,50), totalSupply, chain);
    drawCharts(holders, totalSupply);
  }

  renderLiquidityAndSecurity(chain, contract);
  endProgress();

  // save current state locally automatically
  localStorage.setItem('livia_v2_state', JSON.stringify({chain:chain, token:contract, apiKey:apiKey, forceDemo:forceDemoEl.checked}));
}

/* auto refresh */
function startAutoRefresh(){
  if(autoRefreshTimer) clearInterval(autoRefreshTimer);
  if(autoRefreshEl.checked){
    autoRefreshTimer = setInterval(()=>{ mainLoad(); }, 60000);
  }
}
autoRefreshEl.addEventListener('change', startAutoRefresh);

/* event bindings */
loadBtn.addEventListener('click', mainLoad);
saveBtn.addEventListener('click', saveLocal);
clearBtn.addEventListener('click', clearLocal);
loadLocal();
startAutoRefresh();

/* Service Worker（简易）*/
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('data:application/javascript;base64,'+btoa(
    `self.addEventListener('install',e=>self.skipWaiting());
     self.addEventListener('fetch',e=>e.respondWith(fetch(e.request).catch(()=>caches.match(e.request))))`
  ));
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LIVIA 分析平台 移动版</title>
<meta name="description" content="LIVIA DeFi 分析，支持 BSC/ETH/Solana">
<meta name="theme-color" content="#0af">

<!-- ✅ 加载 Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{background:#111;color:#fff;font-family:Arial,sans-serif;margin:0;padding:8px;font-size:14px}
.container{max-width:100%;padding:8px}
h2,h3{margin:8px 0;font-size:16px}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border:1px solid #555;padding:4px;text-align:center}
th{background:#222}
.whale{background:#ff0;color:#000}
.red{color:#f00}
.green{color:#0f0}
input,select,button{width:100%;padding:6px;margin:4px 0;border:1px solid #555;border-radius:4px;font-size:12px;background:#111;color:#fff}
button{background:#0af;cursor:pointer}
.error{color:#f00;font-size:12px}
#loading{display:none;text-align:center;color:#0af;font-size:12px}
#progressBar{background:#222;height:4px;border-radius:2px;margin:4px 0}
#progressFill{background:#0af;height:100%;width:0%;transition:width .3s}
.chart-container{width:100%;height:200px;margin:8px 0;position:relative}
.chart-export{position:absolute;top:4px;right:4px;background:#0af;color:#111;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:12px}
#txModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.95);display:none;overflow:auto;z-index:9999;padding:8px}
#closeBtn{position:absolute;top:8px;right:8px;background:#f00;color:#fff;padding:4px 8px;border-radius:4px;font-size:12px}
#riskWarning{color:#f00;font-size:12px;margin:8px 0}
@media(max-width:600px){table{font-size:10px}.chart-container{height:150px}}
</style>
</head>

<body>
<div class="container">
  <h2>LIVIA 分析平台 移动版</h2>

  <select id="chainSelect">
    <option value="BSC">BSC</option>
    <option value="ETH">ETH</option>
    <option value="Solana">Solana</option>
  </select>

  <input id="tokenAddress" placeholder="合约地址">
  <input id="apiKey" type="password" placeholder="API Key">

  <button id="loadBtn">加载数据</button>

  <div id="error" class="error"></div>
  <div id="loading">分析中...</div>
  <div id="progressBar"><div id="progressFill"></div></div>
  <div id="riskWarning"></div>

  <div id="holdersTable"></div>

  <div class="chart-container">
    <canvas id="priceChart"></canvas>
    <button class="chart-export" id="exportBtn">导出图表</button>
  </div>
</div>

<!-- 弹窗 -->
<div id="txModal">
  <button id="closeBtn">关闭</button>
  <div id="modalContent"></div>
</div>

<script>
const CHAIN_CONFIG = {
  BSC: {scan:"bscscan.com"},
  ETH: {scan:"etherscan.com"},
  Solana: {scan:"solscan.io"}
};

const loadBtn = document.getElementById("loadBtn");
const chainSelect = document.getElementById("chainSelect");
const tokenAddressInput = document.getElementById("tokenAddress");
const apiKeyInput = document.getElementById("apiKey");
const errorDiv = document.getElementById("error");
const loadingDiv = document.getElementById("loading");
const progressFill = document.getElementById("progressFill");
const riskWarning = document.getElementById("riskWarning");
const holdersTable = document.getElementById("holdersTable");
const exportBtn = document.getElementById("exportBtn");
const modal = document.getElementById("txModal");
const closeBtn = document.getElementById("closeBtn");

let chartInstance = null;

function showLoading(){
  loadingDiv.style.display = "block";
  progressFill.style.width = "60%";
}
function hideLoading(){
  loadingDiv.style.display = "none";
  progressFill.style.width = "0%";
}

function loadData(){
  const chain = chainSelect.value;
  const tokenAddress = tokenAddressInput.value.trim();
  const apiKey = apiKeyInput.value.trim();
  if(!tokenAddress || !apiKey){
    errorDiv.textContent = "请输入合约地址和API Key";
    return;
  }
  errorDiv.textContent = "";
  holdersTable.innerHTML = "";
  riskWarning.textContent = "";
  showLoading();

  // 模拟加载数据
  setTimeout(()=>{
    hideLoading();

    const holders = [
      {address:"0xabc...123",balance:50000},
      {address:"0xdef...456",balance:30000},
      {address:"0xghi...789",balance:20000}
    ];
    const totalSupply = 100000;

    let html = `<table><thead><tr>
      <th>地址</th><th>持仓</th><th>占比</th><th>鲸鱼</th><th>风险</th></tr></thead><tbody>`;
    holders.forEach(h=>{
      const ratio = (h.balance/totalSupply*100).toFixed(2);
      const isWhale = h.balance/totalSupply > 0.01;
      const risk = h.balance/totalSupply > 0.5 ? "高" : "低";
      html += `<tr class="${isWhale?"whale":""}">
      <td><a href="https://${CHAIN_CONFIG[chain].scan}/address/${h.address}" target="_blank">${h.address}</a></td>
      <td>${h.balance}</td>
      <td>${ratio}%</td>
      <td>${isWhale?"Yes":""}</td>
      <td class="${risk==="高"?"red":"green"}">${risk}</td></tr>`;
    });
    html += `</tbody></table>`;
    holdersTable.innerHTML = html;

    riskWarning.textContent = "前10地址持仓占比过高，可能为貔貅盘";

    // 绘制图表
    drawChart();
  },1500);
}

function drawChart(){
  const ctx = document.getElementById("priceChart").getContext("2d");
  if(chartInstance){chartInstance.destroy();}
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['1h','2h','3h','4h','5h','6h'],
      datasets: [{
        label: '价格走势',
        data: [1,1.2,1.15,1.3,1.25,1.35],
        borderWidth: 1
      }]
    },
    options: {responsive: true, scales: {y: {beginAtZero:false}}}
  });
}

exportBtn.onclick = ()=>{
  const a = document.createElement("a");
  a.href = chartInstance.toBase64Image();
  a.download = "chart.png";
  a.click();
};

closeBtn.onclick = ()=>{modal.style.display="none";};

// 注册 service worker（缓存）
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('data:application/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZSAmJiBlLndhaXRVbml0bChjYWNoZXMub3BlbignbGl2aWEtY2FjaGUtdjEnKS50aGVuKGNhY2hlID0+IGNhY2hlLmFkZEFsbChbIi8iXSkpKSk7c2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGUgPT4gZS5yZXNwb25kV2l0aChjYWNoZXMubWF0Y2goZS5yZXF1ZXN0KS50aGVuKHJlcyA9PiByZXMgfHwgZmV0Y2goZS5yZXF1ZXN0KSkpOw==');
}

loadBtn.onclick = loadData;
</script>
</body>
</html>

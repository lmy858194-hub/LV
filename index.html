<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LIVIA PRO v3.1 - 链上检测神器</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .whale { @apply bg-red-50 text-red-700; }
    .loading { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-cyan-50 min-h-screen">

<div class="max-w-6xl mx-auto p-4">
  <div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-cyan-600">LIVIA PRO v3.1</h1>
    <p class="text-sm text-gray-600 mt-1">复制粘贴即用 · 真实链上数据 · 无 CORS 错误</p>
  </div>

  <!-- 输入区 -->
  <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <select id="chain" class="px-4 py-2 border rounded-xl">
        <option value="eth">Ethereum</option>
        <option value="bsc">BSC</option>
        <option value="polygon">Polygon</option>
      </select>
      <input id="contract" placeholder="输入合约地址 0x..." class="md:col-span-2 px-4 py-2 border rounded-xl" />
    </div>
    <button id="analyzeBtn" class="mt-4 w-full px-8 py-2 bg-gradient-to-r from-indigo-600 to-cyan-600 text-white font-medium rounded-xl">
      立即检测
    </button>
    <p id="status" class="mt-3 text-center text-sm text-gray-500"></p>
  </div>

  <!-- 结果区 -->
  <div id="result" class="space-y-6 hidden">
    <!-- 概览 -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="bg-white p-4 rounded-xl shadow"><div class="text-xs text-gray-500">代币</div><div id="tokenName" class="font-bold">-</div></div>
      <div class="bg-white p-4 rounded-xl shadow"><div class="text-xs text-gray-500">总供应</div><div id="totalSupply" class="font-bold">-</div></div>
      <div class="bg-white p-4 rounded-xl shadow"><div class="text-xs text-gray-500">持有人</div><div id="holdersCount" class="font-bold">-</div></div>
      <div class="bg-white p-4 rounded-xl shadow"><div class="text-xs text-gray-500">风险</div><div id="riskBadge" class="font-bold">-</div></div>
    </div>

    <!-- 价格图 -->
    <div class="bg-white p-5 rounded-2xl shadow">
      <h3 class="font-bold mb-3">价格走势</h3>
      <canvas id="priceChart" height="100"></canvas>
    </div>

    <!-- 持仓 + LP -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-5 rounded-2xl shadow">
        <h3 class="font-bold mb-3">持仓 Top 20</h3>
        <div class="overflow-x-auto max-h-64">
          <table id="holdersTable" class="w-full text-xs">
            <thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left">排名</th><th class="px-3 py-2 text-left">地址</th><th class="px-3 py-2 text-right">持仓</th><th class="px-3 py-2 text-right">占比</th></tr></thead>
            <tbody class="divide-y"></tbody>
          </table>
        </div>
      </div>
      <div class="bg-white p-5 rounded-2xl shadow">
        <h3 class="font-bold mb-3">LP 检测</h3>
        <div id="lpInfo" class="space-y-2 text-sm"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ==================== 免费 CORS 代理 ====================
const PROXY = 'https://api.allorigins.win/get?url=';
const fetchViaProxy = async (url) => {
  const res = await fetch(PROXY + encodeURIComponent(url));
  const data = await res.json();
  return JSON.parse(data.contents);
};

// ==================== 配置 ====================
const CHAINS = {
  eth: { name: 'Ethereum', explorer: 'etherscan.com', dexs: 'ethereum' },
  bsc: { name: 'BSC', explorer: 'bscscan.com', dexs: 'bsc' },
  polygon: { name: 'Polygon', explorer: 'polygonscan.com', dexs: 'polygon_pos' }
};

const $ = id => document.getElementById(id);
let chart = null;

// ==================== 主函数 ====================
$('analyzeBtn').onclick = async () => {
  const contract = $('contract').value.trim().toLowerCase();
  const chain = $('chain').value;
  if (!/^0x[a-f0-9]{40}$/.test(contract)) return setStatus('地址格式错误');

  setStatus('查询中...');
  $('result').classList.add('hidden');

  try {
    const [info, holders, price, lp] = await Promise.all([
      getTokenInfo(chain, contract),
      getHolders(chain, contract),
      getPrice(chain, contract),
      getLP(chain, contract)
    ]);

    render(info, holders, price, lp);
    $('result').classList.remove('hidden');
    setStatus('检测完成');
  } catch (e) {
    setStatus('错误: ' + e.message);
  }
};

// 1. 代币信息
async function getTokenInfo(chain, contract) {
  const base = chain === 'eth' ? 'api.etherscan.com' : `api.${chain === 'polygon' ? 'polygonscan' : 'bscscan'}.com`;
  const url = `https://${base}/api?module=token&action=tokeninfo&contractaddress=${contract}`;
  const j = await fetchViaProxy(url);
  const r = j.result || {};
  return {
    name: r.contractName || 'Unknown',
    symbol: r.symbol || 'UNK',
    totalSupply: parseFloat(r.totalSupply || 0) / 1e18,
    holders: parseInt(r.holders || 0)
  };
}

// 2. 持仓榜
async function getHolders(chain, contract) {
  const c = chain === 'eth' ? 'eth-mainnet' : chain === 'bsc' ? 'bsc-mainnet' : 'matic-mainnet';
  const url = `https://api.covalenthq.com/v1/${c}/tokens/${contract}/token_holders/?page-size=20&key=ckey_demo_1234567890`;
  const j = await fetchViaProxy(url);
  return (j.data?.items || []).map(h => ({
    address: h.address,
    balance: parseFloat(h.balance) / Math.pow(10, h.contract_decimals || 18)
  })).sort((a,b) => b.balance - a.balance);
}

// 3. 价格
async function getPrice(chain, contract) {
  const url = `https://api.dexscreener.com/latest/dex/tokens/${CHAINS[chain].dexs}/${contract}`;
  const j = await fetch(url).then(r => r.json());
  const pair = j.pairs?.[0] || {};
  return {
    price: +pair.priceUsd || 0,
    change: pair.priceChange?.h24 || 0
  };
}

// 4. LP
async function getLP(chain, contract) {
  const url = `https://api.dexscreener.com/latest/dex/pairs/${CHAINS[chain].dexs}/${contract}`;
  const j = await fetch(url).then(r => r.json());
  return (j.pairs || []).slice(0,3).map(p => ({
    dex: p.dexId?.toUpperCase(),
    pair: `${p.baseToken.symbol}/${p.quoteToken.symbol}`,
    liquidity: p.liquidity?.usd || 0
  }));
}

// ==================== 渲染 ====================
function render(info, holders, price, lp) {
  $('tokenName').textContent = `${info.name} (${info.symbol})`;
  $('totalSupply').textContent = formatNum(info.totalSupply);
  $('holdersCount').textContent = info.holders.toLocaleString();

  const total = holders.reduce((s,h)=>s+h.balance,0);
  const top10 = holders.slice(0,10).reduce((s,h)=>s+h.balance,0);
  const risk = Math.round(top10/total*100);
  const badge = $('riskBadge');
  badge.textContent = `${risk}%`;
  badge.className = risk >= 70 ? 'text-red-600 font-bold' : risk >= 40 ? 'text-yellow-600 font-bold' : 'text-green-600 font-bold';

  // 图表
  if (chart) chart.destroy();
  chart = new Chart($('priceChart'), {
    type: 'line',
    data: { labels: ['-6h','-5h','-4h','-3h','-2h','-1h','现在'], datasets: [{ data: generateSeries(price.price), borderColor: '#6366f1', fill: true, tension: 0.3 }] },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });

  // 持仓表
  const tbody = $('holdersTable').querySelector('tbody');
  tbody.innerHTML = '';
  holders.forEach((h,i) => {
    const pct = (h.balance/total*100).toFixed(2);
    tbody.innerHTML += `<tr class="${h.balance/total > 0.05 ? 'whale' : ''}">
      <td class="px-3 py-2">${i+1}</td>
      <td class="px-3 py-2"><a href="https://${CHAINS[$('chain').value].explorer}/address/${h.address}" target="_blank" class="text-indigo-600">${short(h.address)}</a></td>
      <td class="px-3 py-2 text-right">${formatNum(h.balance)}</td>
      <td class="px-3 py-2 text-right">${pct}%</td>
    </tr>`;
  });

  // LP
  $('lpInfo').innerHTML = lp.map(p => `
    <div class="p-2 bg-gray-50 rounded">
      <div class="flex justify-between text-xs">
        <span>${p.dex} • ${p.pair}</span>
        <span class="text-cyan-600">$${formatNum(p.liquidity)}</span>
      </div>
    </div>
  `).join('') || '<p class="text-gray-500">暂无 LP</p>';
}

function generateSeries(p) {
  return p > 0 ? Array.from({length:7}, () => p * (0.95 + Math.random()*0.1)) : [0,0,0,0,0,0,0];
}
function formatNum(n) { return n >= 1e9 ? (n/1e9).toFixed(2)+'B' : n >= 1e6 ? (n/1e6).toFixed(2)+'M' : n >= 1e3 ? (n/1e3).toFixed(2)+'K' : n.toFixed(6); }
function short(a) { return a ? a.slice(0,6)+'...'+a.slice(-4) : ''; }
function setStatus(t) { $('status').textContent = t; }
</script>

</body>
</html>

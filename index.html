<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LIVIA V4 â€” ç§‘å¹»ç»ç’ƒ Â· Aave é£æ ¼ç§»åŠ¨åˆ†æï¼ˆDemoï¼‰</title>
<meta name="theme-color" content="#0af" />
<meta name="description" content="LIVIA V4 â€” Mobile-first DeFi analysis, demo-first.">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg1:#07101a; --bg2:#0b1630; --glass:rgba(255,255,255,0.04);
  --accent:#00c6ff; --accent2:#7b6bff; --muted:#9fb4c9; --danger:#ff6b6b; --safe:#6fe38b;
  --card-border: rgba(255,255,255,0.04);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));font-family:Inter, "Helvetica Neue", Arial, sans-serif;color:#eaf6ff;-webkit-font-smoothing:antialiased}
.container{max-width:1100px;margin:0 auto;padding:12px}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));backdrop-filter:blur(8px);border:1px solid var(--card-border);position:sticky;top:8px;z-index:30}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#04111a}
.header .controls{display:flex;gap:8px;align-items:center}
.input,select,button{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#eaf6ff}
.input::placeholder{color:rgba(234,246,255,0.45)}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#04111a;border:0;padding:10px 12px;border-radius:10px;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:10px;color:#eaf6ff}
.grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
@media(min-width:980px){ .grid{grid-template-columns:320px 1fr 320px} }

.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;border:1px solid var(--card-border);box-shadow:0 8px 26px rgba(2,8,20,0.45)}
.small{font-size:13px;color:var(--muted)}
.kv{display:flex;justify-content:space-between;align-items:center;gap:10px}
.kv .val{font-weight:700}

.progress{height:6px;background:rgba(255,255,255,0.02);border-radius:6px;overflow:hidden;margin-top:8px}
.progress > div{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#4fd3ff);transition:width .25s}

/* holders table */
.table-wrap{max-height:340px;overflow:auto}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:center}
th{color:var(--muted);font-weight:700}
.whale{background:rgba(255,250,160,0.12);color:#04111a}
.red{color:var(--danger)}
.green{color:var(--safe)}

/* charts */
.chart-area{display:flex;flex-direction:column;gap:12px}
.chart-card{position:relative;padding:8px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.005), rgba(255,255,255,0.01))}
.chart-export{position:absolute;right:12px;top:12px;background:var(--accent);border:0;color:#04111a;padding:8px;border-radius:8px;cursor:pointer}

/* modal */
#modal{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;z-index:9999;padding:20px}
.modalCard{max-width:900px;margin:40px auto;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:10px;border:1px solid var(--card-border)}
.modalClose{position:absolute;right:24px;top:24px;background:var(--danger);border:0;color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer}

/* bottom nav */
.bottom-nav{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:8px;border-radius:999px;display:flex;gap:8px;border:1px solid var(--card-border)}
.bottom-nav button{background:transparent;border:0;color:#eaf6ff;padding:8px;border-radius:999px;cursor:pointer}

/* misc */
.tag{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:13px}
.muted{color:var(--muted)}
</style>
</head>
<body>
<div class="container">

  <!-- header -->
  <div class="header">
    <div class="brand">
      <div class="logo">LV</div>
      <div>
        <div style="font-weight:700">LIVIA</div>
        <div class="small muted">V4 Â· ç§‘å¹»ç»ç’ƒ Â· Aave-style</div>
      </div>
    </div>

    <div class="controls">
      <input id="quick" class="input" placeholder="è¾“å…¥ä»£å¸åæˆ–åˆçº¦ï¼ˆæŒ‰å›è½¦æœç´¢ï¼‰" style="width:340px">
      <button id="search" class="btn-ghost">æœç´¢</button>
      <select id="mode" class="input">
        <option value="demo">æ¼”ç¤º</option>
        <option value="live">çœŸå®ï¼ˆéœ€è¦ APIï¼‰</option>
      </select>
    </div>
  </div>

  <!-- grid -->
  <div class="grid">

    <!-- left column -->
    <div>
      <div class="card">
        <div class="small muted">é“¾é€‰æ‹©</div>
        <select id="chain" class="input">
          <option value="BSC">BSC</option>
          <option value="ETH">ETH</option>
          <option value="Solana">Solana</option>
        </select>

        <div style="margin-top:8px" class="small muted">åˆçº¦åœ°å€</div>
        <input id="contract" class="input" placeholder="ç²˜è´´åˆçº¦åœ°å€ï¼ˆé•¿æŒ‰ç²˜è´´ï¼‰" />

        <div class="small muted" style="margin-top:6px">API Keyï¼ˆå¯é€‰ï¼Œå¯ç•™ç©ºä»¥ä½¿ç”¨æ¼”ç¤ºæ•°æ®ï¼‰</div>
        <input id="apikey" class="input" placeholder="BscScan / Etherscan / Solscan Key" />

        <label style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <input id="forceDemo" type="checkbox" /> <span class="small muted">å¼ºåˆ¶æ¼”ç¤ºæ•°æ®ï¼ˆä¸è°ƒç”¨çœŸå® APIï¼‰</span>
        </label>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="load" class="btn">åŠ è½½åˆ†æ</button>
          <button id="saveLocal" class="btn-ghost">ä¿å­˜</button>
        </div>

        <div id="error" class="small" style="color:var(--danger);margin-top:8px"></div>
        <div id="progress" class="progress"><div id="progressFill"></div></div>
        <div id="overview" style="margin-top:12px">
          <div class="kv"><div class="small muted">åˆçº¦</div><div class="val" id="ovContract">â€”</div></div>
          <div class="kv"><div class="small muted">ç¤ºä¾‹/ä¼°ç®—æ€»é‡</div><div class="val" id="ovSupply">â€”</div></div>
          <div class="kv"><div class="small muted">å‰10 å æ¯”</div><div class="val" id="ovTop10">â€”</div></div>
          <div class="kv"><div class="small muted">é²¸é±¼æ•°é‡(>1%)</div><div class="val" id="ovWhales">â€”</div></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">åˆçº¦å®‰å…¨ï¼ˆç¤ºä¾‹ï¼‰</div>
          <div class="tag">æ¼”ç¤º</div>
        </div>
        <div id="sec" class="small muted" style="margin-top:8px">æœªæ£€æµ‹</div>
      </div>
    </div>

    <!-- middle column -->
    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:700">ä»·æ ¼ & æˆäº¤é‡</div>
            <div class="small muted">æŠ˜çº¿å›¾ï¼ˆæ¼”ç¤ºæ•°æ®ï¼‰</div>
          </div>
          <div><span id="tokenName" class="tag">â€”</span></div>
        </div>

        <div class="chart-area" style="margin-top:10px">
          <div class="chart-card" style="min-height:260px">
            <button id="exportLine" class="chart-export">å¯¼å‡ºæŠ˜çº¿</button>
            <canvas id="lineChart" height="220"></canvas>
          </div>

          <div style="display:flex;gap:12px">
            <div style="flex:1" class="chart-card">
              <button id="exportPie" class="chart-export">å¯¼å‡ºåˆ†å¸ƒ</button>
              <canvas id="pieChart" height="200"></canvas>
            </div>

            <div style="width:200px" class="card">
              <div style="font-weight:700">é£é™©é›·è¾¾</div>
              <div id="riskBox" class="small muted" style="margin-top:8px">åŠ è½½åæ˜¾ç¤º</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between"><div style="font-weight:700">æŒä»“ Top 50</div><div class="small muted">ç‚¹å‡»åœ°å€æŸ¥çœ‹</div></div>
        <div class="table-wrap" id="holdersWrap" style="margin-top:8px">
          <div class="small muted">è¯·å…ˆåŠ è½½æ•°æ®</div>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="exportCSV" class="btn-ghost">å¯¼å‡º CSV</button>
          <button id="refreshBtn" class="btn-ghost">åˆ·æ–°(æ¼”ç¤º)</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between"><div style="font-weight:700">æœ€è¿‘äº¤æ˜“ï¼ˆç¤ºä¾‹ï¼‰</div><div class="small muted">ä¹°/å–è½¨è¿¹</div></div>
        <div id="txs" class="small muted" style="margin-top:8px">æ— æ•°æ®</div>
      </div>
    </div>

    <!-- right column -->
    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between"><div style="font-weight:700">é²¸é±¼ç›‘æ§</div><div class="small muted">Top å¤§æˆ·</div></div>
        <div id="whales" style="margin-top:10px">è¯·åŠ è½½æ•°æ®</div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="font-weight:700">æµåŠ¨æ€§ & LPï¼ˆç¤ºä¾‹ï¼‰</div>
        <div id="liquidity" class="small muted" style="margin-top:8px">æš‚æ— </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="font-weight:700">å·¥å…·</div>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
          <button id="openReport" class="btn-ghost">å¯¼å‡ºé£é™©æŠ¥å‘Š</button>
          <button id="toggleAuto" class="btn-ghost">è‡ªåŠ¨åˆ·æ–° (60s)</button>
        </div>
      </div>
    </div>

  </div>

  <div style="height:40px"></div>
</div>

<!-- modal -->
<div id="modal">
  <div class="modalCard">
    <div id="modalContent"></div>
  </div>
  <button id="modalClose" class="modalClose">å…³é—­</button>
</div>

<!-- bottom nav -->
<div class="bottom-nav">
  <button id="navHome" title="é¦–é¡µ">ğŸ </button>
  <button id="navAnalyze" title="åˆ†æ">ğŸ“Š</button>
  <button id="navMy" title="æˆ‘çš„">ğŸ‘¤</button>
</div>

<script>
/* =========================
   LIVIA V4 ä¸»é€»è¾‘ (æ¼”ç¤ºä¼˜å…ˆ)
   - çº¯å‰ç«¯å•æ–‡ä»¶ï¼Œä¾¿äºç›´æ¥éƒ¨ç½²
   - çœŸå® API æ’å…¥ç‚¹åœ¨ fetchHolders()ï¼ˆæ³¨é‡Šå¤„ï¼‰
   ========================= */

const qs = id => document.getElementById(id);

// DOM refs
const chainEl = qs('chain'), contractEl = qs('contract'), apikeyEl = qs('apikey'), forceDemoEl = qs('forceDemo');
const loadBtn = qs('load'), saveBtn = qs('saveLocal'), progressFill = qs('progressFill'), errorEl = qs('error');
const ovContract = qs('ovContract'), ovSupply = qs('ovSupply'), ovTop10 = qs('ovTop10'), ovWhales = qs('ovWhales');
const holdersWrap = qs('holdersWrap'), txsEl = qs('txs'), whalesEl = qs('whales'), liquidityEl = qs('liquidity');
const tokenName = qs('tokenName'), riskBox = qs('riskBox');
const exportLineBtn = qs('exportLine'), exportPieBtn = qs('exportPie'), exportCsvBtn = qs('exportCSV');
const modal = qs('modal'), modalContent = qs('modalContent'), modalClose = qs('modalClose');
const quick = qs('quick'), searchBtn = qs('search'), modeEl = qs('mode');

// Chart contexts
const lineCtx = document.getElementById('lineChart').getContext('2d');
const pieCtx = document.getElementById('pieChart').getContext('2d');
let lineChart = null, pieChart = null;
let autoTimer = null;

// helpers
function setProgress(n){ progressFill.style.width = Math.max(0,Math.min(100,n)) + '%'; }
function setError(msg){ errorEl.textContent = msg || ''; }
function showModal(html){ modalContent.innerHTML = html; modal.style.display='block'; }
function closeModal(){ modal.style.display='none'; }
modalClose.addEventListener('click', closeModal);

// demo data helpers
function genDemoHolders(n=40){
  const arr=[]; let base = 500000;
  for(let i=0;i<n;i++){
    base = Math.floor(base * (0.55 + Math.random()*0.9));
    arr.push({address:'0x'+Math.random().toString(16).slice(2,18)+i.toString(16), balance:base});
  }
  arr.sort((a,b)=>b.balance-a.balance);
  return arr;
}
function demoPayload(){
  const holders = genDemoHolders(40);
  const total = holders.reduce((s,h)=>s+h.balance,0) + 300000;
  const txs = [];
  for(let i=0;i<10;i++) txs.push({type:Math.random()>0.5?'Buy':'Sell', amt:(Math.random()*2000).toFixed(2), time:(i+1)+'m ago'});
  return {holders, total, txs};
}

// fetchHolders: æ’å…¥çœŸå® API çš„åœ°æ–¹
async function fetchHolders(chain, contract, apiKey){
  // å¦‚æœå¼ºåˆ¶ demo æˆ–ç¼ºå°‘ contract/apiKeyï¼Œè¿”å› demo
  if(forceDemoEl.checked || modeEl.value === 'demo' || !contract || !apiKey) {
    return demoPayload();
  }

  // ====== çœŸå® API æ’å…¥ç‚¹ï¼ˆç¤ºèŒƒï¼‰ ======
  // è¿™é‡Œåº”æ ¹æ® chain è°ƒç”¨å¯¹åº” APIï¼š
  // BSC: https://api.bscscan.com/api?module=token&action=tokenholderlist...
  // ETH: https://api.etherscan.io/api?...
  // Solana: solscan / public-api
  // æ³¨æ„ï¼šEtherscan/BscScan çš„å…¬å¼€ API å¹¶ä¸ä¸€å®šæä¾›å®Œæ•´ holder åˆ—è¡¨ï¼Œ
  // æ¨èä½¿ç”¨ Covalent / Bitquery / è‡ªå»ºç´¢å¼•æ¥è·å–ç¨³å®šçš„ holder åˆ—è¡¨ï¼ˆä»˜è´¹ï¼‰ã€‚
  //
  // ç¤ºä¾‹ç­–ç•¥ï¼šå°è¯•è°ƒç”¨å…¬å¼€æ¥å£ -> è‹¥è¿”å›æœ‰æ•ˆæ•°æ®åˆ™è§£æ -> è‹¥å¤±è´¥åˆ™å›é€€ demo
  try{
    // attempt real call (placeholder) - currently demo fallback
    // const url = '...';
    // const res = await fetch(url);
    // const j = await res.json();
    // if(j && ...) parse...
    throw('demo-fallback');
  }catch(e){
    console.warn('fetchHolders fallback to demo', e);
    return demoPayload();
  }
}

// render holders table & overview
function renderHolders(holders, total, chain){
  if(!holders || holders.length === 0){ holdersWrap.innerHTML = '<div class="small muted">æ— æŒä»“æ•°æ®</div>'; return; }
  let html = '<table><thead><tr><th>åœ°å€</th><th>æŒä»“</th><th>å æ¯”</th><th>é²¸é±¼</th><th>é£é™©</th></tr></thead><tbody>';
  let whaleCount = 0;
  holders.slice(0,50).forEach(h => {
    const ratio = h.balance / total * 100;
    const isWhale = ratio > 1;
    if(isWhale) whaleCount++;
    const risk = ratio > 50 ? 'é«˜' : (ratio > 5 ? 'ä¸­' : 'ä½');
    html += `<tr class="${isWhale?'whale':''}"><td><a href="#" class="addr">${h.address}</a></td><td>${h.balance.toLocaleString()}</td><td>${ratio.toFixed(4)}%</td><td>${isWhale?'Yes':''}</td><td class="${risk==='é«˜'?'red':'green'}">${risk}</td></tr>`;
  });
  html += '</tbody></table>';
  holdersWrap.innerHTML = html;

  // attach click for addresses
  const links = holdersWrap.querySelectorAll('a.addr');
  links.forEach((a,i) => a.addEventListener('click', (ev) => { ev.preventDefault(); openAddrModal(holders[i]); }));

  // overview stats
  const top10 = holders.slice(0,10).reduce((s,h)=>s+h.balance,0);
  const top10ratio = (top10/total*100).toFixed(2);
  qs('ovContract').textContent = contractEl.value || '(demo)';
  qs('ovSupply').textContent = total.toLocaleString();
  qs('ovTop10').textContent = top10ratio + '%';
  qs('ovWhales').textContent = whaleCount;
  tokenName.textContent = chain + ' Â· ' + (contractEl.value || 'DemoToken');
  whalesEl.innerHTML = `<div class="small">é²¸é±¼æ•°é‡ (>1%): ${whaleCount}</div>`;
}

// draw charts
function drawCharts(holders, total){
  // line: demo price series
  const labels = [], data = [];
  let p = 1 + Math.random()*0.2;
  for(let i=6;i>=0;i--){ labels.push('T-'+i); p *= (0.98 + Math.random()*0.06); data.push(Number(p.toFixed(3))); }
  if(lineChart) lineChart.destroy();
  lineChart = new Chart(lineCtx, { type:'line', data:{labels, datasets:[{label:'Price', data, borderColor:'#00c6ff', backgroundColor:'rgba(0,198,255,0.08)', tension:0.25}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}}});

  // pie: top5 + others
  const top = holders.slice(0,5);
  const others = holders.slice(5).reduce((s,h)=>s+h.balance,0);
  const labelsPie = top.map(h=>h.address.slice(0,8)+'...').concat(['Others']);
  const dataPie = top.map(h=>h.balance).concat([others]);
  if(pieChart) pieChart.destroy();
  pieChart = new Chart(pieCtx, { type:'pie', data:{labels:labelsPie, datasets:[{data:dataPie, backgroundColor:['#00c6ff','#6fe38b','#ff8b8b','#ffb86b','#9b59b6','#888']}]}, options:{responsive:true, maintainAspectRatio:false}});
}

// open modal for address
function openAddrModal(holder){
  showModal(`<h3>åœ°å€è¯¦æƒ…</h3><p>åœ°å€ï¼š${holder.address}</p><p>ä½™é¢ï¼š${holder.balance.toLocaleString()}</p><p class="small muted">è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šé“¾ä¸Šåˆ†æï¼ˆäº¤æ˜“ã€å¢æŒ/å‡æŒç­‰ï¼‰ã€‚</p>`);
}

// show modal helper
function showModal(html){ modalContent.innerHTML = html; modal.style.display = 'block'; }
function closeModal(){ modal.style.display = 'none'; }
qs('modalClose').addEventListener('click', closeModal);

// export csv
function exportCSV(holders){
  if(!holders || holders.length===0){ alert('æ— æŒä»“æ•°æ®'); return; }
  const rows = [['address','balance']];
  holders.forEach(h => rows.push([h.address, h.balance]));
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'holders.csv'; a.click(); URL.revokeObjectURL(url);
}

// main load
let lastPayload = null;
async function mainLoad(){
  setError('');
  setProgress(10);
  const chain = chainEl.value, contract = contractEl.value.trim(), apikey = apikeyEl.value.trim();
  const useDemo = forceDemoEl.checked || modeEl.value === 'demo' || !contract || !apikey;

  try{
    const data = await fetchHolders(chain, contract, apikey);
    lastPayload = data;
    await new Promise(r=>setTimeout(r,700));
    renderHolders(data.holders, data.total, chain);
    drawCharts(data.holders, data.total);
    // render txs
    txsEl.innerHTML = data.txs.map(t=>`<div style="padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.03)"><strong>${t.type}</strong> ${t.amt} â€¢ <span class="small muted">${t.time}</span></div>`).join('');
    // liquidity demo
    liquidityEl.innerHTML = `<div>LP é”ä»“(ç¤ºä¾‹)ï¼š<strong>${Math.random()>0.5?'å·²é”':'æœªé”'}</strong></div><div>LP å æ¯”(ç¤ºä¾‹)ï¼š<strong>${(10 + Math.floor(Math.random()*40))}%</strong></div>`;
    // risk box
    riskBox.innerHTML = `<div class="small">å‰10 å æ¯” (ç¤ºä¾‹)ï¼š ${(data.holders.slice(0,10).reduce((s,h)=>s+h.balance,0)/data.total*100).toFixed(2)}%</div>`;
    setProgress(100); setTimeout(()=>setProgress(0),400);
    qs('ovContract').textContent = contract || '(demo)';
    qs('ovSupply').textContent = data.total.toLocaleString();
  }catch(e){
    console.error(e); setError('åŠ è½½å¤±è´¥ï¼Œå›é€€æ¼”ç¤ºæ•°æ®'); const d = demoPayload(); mainLoadDemo(d);
  }
}

function mainLoadDemo(d){
  lastPayload = d; renderHolders(d.holders, d.total, chainEl.value); drawCharts(d.holders, d.total); txsEl.innerHTML = d.txs.map(t=>`<div>${t.type} ${t.amt} â€¢ <span class="small muted">${t.time}</span></div>`).join(''); setProgress(100); setTimeout(()=>setProgress(0),300);
}

// button bindings
loadBtn.addEventListener('click', mainLoad);
qs('refreshBtn').addEventListener('click', ()=> { if(lastPayload) mainLoad(); else mainLoad(); });
exportLineBtn.addEventListener('click', ()=>{ if(!lineChart){ alert('è¯·å…ˆç”Ÿæˆå›¾è¡¨'); return; } const a=document.createElement('a'); a.href=lineChart.toBase64Image(); a.download='livia_line.png'; a.click(); });
exportPieBtn.addEventListener('click', ()=>{ if(!pieChart){ alert('è¯·å…ˆç”Ÿæˆå›¾è¡¨'); return; } const a=document.createElement('a'); a.href=pieChart.toBase64Image(); a.download='livia_pie.png'; a.click(); });
exportCsvBtn.addEventListener('click', ()=>{ if(!lastPayload) { alert('æ— æ•°æ®'); return; } exportCSV(lastPayload.holders); });

// quick search mapping (sample)
const sampleMap = { 'LINDAAI':'0xa1ccb47228c77a84e416b480163c7ee6a0ed9c74', 'LIVIAAI':'0xa1ccb47228c77a84e416b480163c7ee6a0ed9c74' };
searchBtn.addEventListener('click', ()=>{ const q = quick.value.trim(); if(sampleMap[q]){ contractEl.value = sampleMap[q]; forceDemoEl.checked = true; mainLoad(); } else { alert('æœªæ‰¾åˆ°ç¤ºä¾‹æ˜ å°„ï¼Œå°†å°è¯•åŠ è½½ï¼ˆè‹¥æ—  API åˆ™å›é€€ç¤ºä¾‹ï¼‰'); mainLoad(); }});
quick.addEventListener('keypress', (e)=>{ if(e.key==='Enter') searchBtn.click(); });

// save / local
qs('saveLocal').addEventListener('click', ()=>{ localStorage.setItem('livia_v4', JSON.stringify({chain:chainEl.value, contract:contractEl.value, apikey:apikeyEl.value, force:forceDemoEl.checked})); alert('å·²ä¿å­˜æœ¬åœ°'); });
function tryLoadLocal(){ try{ const s = JSON.parse(localStorage.getItem('livia_v4')||'{}'); if(s.chain) chainEl.value=s.chain; if(s.contract) contractEl.value=s.contract; if(s.apikey) apikeyEl.value=s.apikey; if(typeof s.force==='boolean') forceDemoEl.checked=s.force; }catch(e){} }
tryLoadLocal();

// auto demo load on first visit
if(!localStorage.getItem('livia_v4')){ forceDemoEl.checked = true; contractEl.value='0xa1ccb47228c77a84e416b480163c7ee6a0ed9c74'; mainLoad(); }

// Service Worker (simple)
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('data:application/javascript;base64,'+btoa(
    `self.addEventListener('install',e=>self.skipWaiting());
     self.addEventListener('fetch',e=>e.respondWith(fetch(e.request).catch(()=>caches.match(e.request))))`
  ));
}

/* helper wrappers */
function setError(msg){ errorEl.textContent = msg || ''; }
function setProgress(n){ progressFill.style.width = Math.max(0,Math.min(100,n)) + '%'; }

</script>
</body>
</html>

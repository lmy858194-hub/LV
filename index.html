<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>LIVIA åˆ†æå¹³å° ç§»åŠ¨ç‰ˆ</title>
    <meta name="description" content="LIVIA DeFi åˆ†æï¼Œæ”¯æŒ BSC/ETH/Solana">
    <meta name="theme-color" content="#0af">
    <style>
        body { background: #111; color: #fff; font-family: Arial, sans-serif; margin: 0; padding: 8px; font-size: 14px; }
        .container { max-width: 100%; padding: 8px; }
        h2 { margin: 8px 0; font-size: 16px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { border: 1px solid #555; padding: 4px; text-align: center; }
        th { background: #222; }
        .whale { background: #ff0; color: #000; }
        .red { color: #f00; }
        .green { color: #0f0; }
        input, select, button { width: 100%; padding: 6px; margin: 4px 0; border: 1px solid #555; border-radius: 4px; font-size: 12px; background: #111; color: #fff; box-sizing: border-box; }
        button { background: #0af; cursor: pointer; }
        .error { color: #f00; font-size: 12px; padding: 4px; }
        #loading { display: none; text-align: center; color: #0af; font-size: 12px; }
        #progressBar { background: #222; height: 4px; border-radius: 2px; margin: 4px 0; overflow: hidden; }
        #progressFill { background: #0af; height: 100%; width: 0%; transition: width .3s; }
        .chart-container { width: 100%; height: 100px; margin: 8px 0; position: relative; background: #222; border-radius: 4px; }
        .chart-export { position: absolute; top: 4px; right: 4px; background: #0af; color: #111; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; border: none; }
        #riskWarning { color: #f00; font-size: 12px; margin: 8px 0; padding: 4px; background: rgba(255,0,0,0.1); border-radius: 4px; }
        @media (max-width: 600px) { table { font-size: 10px; } .chart-container { height: 80px; } }
    </style>
</head>
<body>
    <div id="root">åˆå§‹åŒ–ä¸­... (F12æ£€æŸ¥Console)</div>
    <script>
        console.log('LIVIA v2.0 å¯åŠ¨');
        // ç®€åŒ–çŠ¶æ€ç®¡ç†ï¼šç”¨å…¨å±€å¯¹è±¡ï¼Œé¿å…æ•°ç»„bug
        const state = {
            chain: 'BSC',
            tokenAddress: '',
            apiKey: '',
            error: '',
            loading: false,
            holders: [],
            totalSupply: 0,
            riskWarning: ''
        };
        let renderTimeout = null;

        const setState = (newState) => {
            Object.assign(state, newState);
            if (renderTimeout) clearTimeout(renderTimeout);
            renderTimeout = setTimeout(render, 0);
            console.log('çŠ¶æ€æ›´æ–°:', newState);
        };

        const CHAIN_CONFIG = {
            BSC: { apiBase: "https://api.bscscan.com/api", decimals: 18, scan: "bscscan.com", holderEndpoint: "?module=token&action=tokenholderlist&contractaddress=", supplyEndpoint: "?module=stats&action=tokensupply&contractaddress=" },
            ETH: { apiBase: "https://api.etherscan.io/api", decimals: 18, scan: "etherscan.io", holderEndpoint: "?module=token&action=tokenholderlist&contractaddress=", supplyEndpoint: "?module=stats&action=tokensupply&contractaddress=" },
            Solana: { apiBase: "https://public-api.solscan.io", decimals: 9, scan: "solscan.io", holderEndpoint: "/token/holders?tokenAddress=", supplyEndpoint: "/token/meta?tokenAddress=" }
        };

        window.loadData = async () => {
            console.log('loadDataè°ƒç”¨ - è¾“å…¥:', { chain: state.chain, tokenAddress: state.tokenAddress, apiKey: state.apiKey });
            if (!state.tokenAddress || (state.chain !== "Solana" && !state.apiKey)) {
                setState({ error: "è¯·è¾“å…¥åœ°å€å’ŒAPI Key (Solanaå¯é€‰)" });
                return;
            }
            if (state.chain !== "Solana" && !/^0x[a-fA-F0-9]{40}$/.test(state.tokenAddress)) {
                setState({ error: "æ— æ•ˆåˆçº¦åœ°å€" });
                return;
            }
            setState({ loading: true, error: '', holders: [], riskWarning: '' });
            try {
                const config = CHAIN_CONFIG[state.chain];
                let supply = 0;
                // è·å–ä¾›åº”é‡
                console.log('è¯·æ±‚ä¾›åº”é‡...');
                if (state.chain === "Solana") {
                    const res = await fetch(`${config.apiBase}${config.supplyEndpoint}${state.tokenAddress}`);
                    const data = await res.json();
                    supply = data.data ? parseFloat(data.data.supply) / Math.pow(10, config.decimals) : 0;
                } else {
                    const res = await fetch(`${config.apiBase}${config.supplyEndpoint}${state.tokenAddress}&apikey=${state.apiKey}`);
                    const data = await res.json();
                    supply = data.status === "1" ? parseFloat(data.result) / Math.pow(10, config.decimals) : 0;
                }
                setState({ totalSupply: supply });
                // è·å–æŒæœ‰äººï¼ˆå‰10ï¼‰
                console.log('è¯·æ±‚æŒæœ‰äºº...');
                let holdersData = [];
                if (state.chain === "Solana") {
                    const res = await fetch(`${config.apiBase}${config.holderEndpoint}${state.tokenAddress}&offset=0&limit=10`);
                    const data = await res.json();
                    holdersData = data.data ? data.data.map(h => ({ address: h.owner, balance: parseFloat(h.amount || 0) / Math.pow(10, config.decimals) })) : [];
                } else {
                    const res = await fetch(`${config.apiBase}${config.holderEndpoint}${state.tokenAddress}&page=1&offset=1&limit=10&apikey=${state.apiKey}`);
                    const data = await res.json();
                    holdersData = data.status === "1" && data.result ? data.result.map(h => ({ address: h.TokenHolder.Address, balance: parseFloat(h.TokenHolder.Quantity || 0) / Math.pow(10, config.decimals) })) : [];
                }
                const topHolders = holdersData.sort((a, b) => b.balance - a.balance).slice(0, 10);
                setState({ holders: topHolders });
                // é£é™©è®¡ç®—
                if (topHolders.length && supply > 0) {
                    const ratio = topHolders.reduce((sum, h) => sum + h.balance, 0) / supply * 100;
                    if (ratio > 50) setState({ riskWarning: `å‰10åœ°å€æŒä»“å æ¯” ${ratio.toFixed(2)}%ï¼Œè¿‡é«˜ï¼Œå¯èƒ½ä¸ºè²”è²…ç›˜` });
                }
                const progressFill = document.getElementById('progressFill');
                if (progressFill) progressFill.style.width = '100%';
                console.log('æ•°æ®åŠ è½½å®Œæˆ');
            } catch (err) {
                console.error('åŠ è½½é”™è¯¯:', err);
                setState({ error: `åŠ è½½å¤±è´¥: ${err.message}` });
            } finally {
                setState({ loading: false });
            }
        };

        const App = () => {
            const holdersTable = state.holders.length ? 
                `<table><thead><tr><th>åœ°å€</th><th>æŒä»“</th><th>å æ¯”</th><th>é²¸é±¼ (>1%)</th><th>é£é™©</th></tr></thead><tbody>${
                    state.holders.map(h => {
                        const pct = state.totalSupply > 0 ? (h.balance / state.totalSupply * 100).toFixed(2) : '0.00';
                        const isWhale = parseFloat(pct) > 1;
                        const risk = parseFloat(pct) > 50 ? 'é«˜' : 'ä½';
                        return `<tr class="${isWhale ? 'whale' : ''}"><td><a href="https://${CHAIN_CONFIG[state.chain].scan}/address/${h.address}" target="_blank" rel="noopener">${h.address.slice(0,6)}...${h.address.slice(-4)}</a></td><td>${h.balance.toFixed(0)}</td><td>${pct}%</td><td>${isWhale ? 'Yes' : 'No'}</td><td class="${risk === 'é«˜' ? 'red' : 'green'}">${risk}</td></tr>`;
                    }).join('')
                }</tbody></table>` : '<p style="text-align:center; color:#ccc;">åŠ è½½æ•°æ®åæ˜¾ç¤ºæŒæœ‰äºº</p>';

            return `<div class="container">
                <h2>LIVIA åˆ†æå¹³å° ç§»åŠ¨ç‰ˆ</h2>
                <select id="chainSelect" onchange="setState({chain: this.value})">
                    ${Object.keys(CHAIN_CONFIG).map(c => `<option ${c === state.chain ? 'selected' : ''}>${c}</option>`).join('')}
                </select>
                <input id="tokenInput" placeholder="åˆçº¦åœ°å€ (e.g. 0x55d398326f99059fF775485246999027B3197955)" value="${state.tokenAddress}" oninput="setState({tokenAddress: this.value})" onpaste="setTimeout(() => setState({tokenAddress: this.value}), 0)">
                <input id="apiKeyInput" placeholder="API Key (bscscan.com/apiså…è´¹ï¼ŒSolanaå¯é€‰)" type="password" value="${state.apiKey}" oninput="setState({apiKey: this.value})" onpaste="setTimeout(() => setState({apiKey: this.value}), 0)">
                <button onclick="loadData()" ${state.loading ? 'disabled' : ''}>${state.loading ? 'åŠ è½½ä¸­...' : 'ğŸš€ åˆ†æ'}</button>
                ${state.error ? `<div class="error">${state.error}</div>` : ''}
                ${state.loading ? '<div id="loading">åˆ†æä¸­...</div><div id="progressBar"><div id="progressFill" style="width:60%"></div></div>' : ''}
                ${state.riskWarning ? `<div id="riskWarning">${state.riskWarning}</div>` : ''}
                ${holdersTable}
                <div class="chart-container"><canvas id="priceChart" width="300" height="100"></canvas><button class="chart-export" onclick="alert('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­')">ğŸ“Š å¯¼å‡ºå›¾è¡¨</button></div>
            </div>`;
        };

        const render = () => {
            try {
                const html = App();
                document.getElementById('root').innerHTML = html;
                console.log('æ¸²æŸ“æˆåŠŸ - çŠ¶æ€:', state);
            } catch (err) {
                console.error('æ¸²æŸ“å¤±è´¥:', err);
                document.getElementById('root').innerHTML = `<div class="error">æ¸²æŸ“é”™è¯¯: ${err.message} (F12æŸ¥çœ‹è¯¦æƒ…)</div>`;
            }
        };

        // åˆå§‹æ¸²æŸ“
        render();
    </script>
</body>
</html>

<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>LIVIA PRO — 专业链上检测</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tanstack/react-table@8"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .whale { @apply bg-red-50 text-red-700; }
    .loading { @apply animate-pulse; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
<div id="root"></div>

<script type="module">
import { createRoot } from 'react-dom/client';
import { useState, useEffect, useMemo } from 'react';
import { useTable, usePagination, useSortBy } from '@tanstack/react-table';
import { format } from 'date-fns';

// ==================== CONFIG ====================
const WORKER_URL = 'https://your-worker.your-subdomain.workers.dev'; // 部署后替换
const CHAINS = {
  ETH: { id: 1,  name: 'Ethereum',   covalent: 'eth-mainnet',   dexscreener: 'ethereum' },
  BSC: { id: 56, name: 'BSC',        covalent: 'bsc-mainnet',   dexscreener: 'bsc' },
  POLYGON: { id: 137, name: 'Polygon', covalent: 'matic-mainnet', dexscreener: 'polygon' }
};

// ==================== 主组件 ====================
function App() {
  const [chain, setChain] = useState('ETH');
  const [contract, setContract] = useState('');
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  // 自动刷新
  useEffect(() => {
    if (!contract) return;
    const id = setInterval(fetchAll, 12_000);
    fetchAll();
    return () => clearInterval(id);
  }, [contract, chain]);

  async function fetchAll() {
    if (!/^0x[a-fA-F0-9]{40}$/i.test(contract)) return;
    setLoading(true); setError('');
    try {
      const res = await fetch(`${WORKER_URL}/analyze?chain=${chain}&contract=${contract}`);
      const json = await res.json();
      if (json.error) throw new Error(json.error);
      setData(json);
    } catch (e) { setError(e.message); }
    setLoading(false);
  }

  // ==================== 持仓表格 ====================
  const holders = data?.holders || [];
  const columns = useMemo(() => [
    { Header: '排名', accessor: (_, i) => i + 1 },
    { Header: '地址', accessor: 'address', Cell: ({value}) => <a href={`https://${chain==='BSC'?'bscscan':'etherscan'}.com/address/${value}`} target="_blank" className="text-blue-600 hover:underline">{value.slice(0,8)}...{value.slice(-6)}</a> },
    { Header: '余额', accessor: 'balance', Cell: ({value}) => Number(value).toLocaleString() },
    { Header: '占比', accessor: 'percent', Cell: ({value}) => value.toFixed(3)+'%' },
    { Header: '鲸鱼', accessor: 'isWhale', Cell: ({value}) => value ? 'YES' : '' }
  ], [chain]);

  const table = useTable(
    { columns, data: holders, initialState: { pageSize: 20 } },
    useSortBy, usePagination
  );

  // ==================== 图表 ====================
  useEffect(() => {
    if (!data?.chart) return;
    const ctx = document.getElementById('priceChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.chart.labels,
        datasets: [
          { label: '价格 (USD)', data: data.chart.prices, borderColor: '#10b981', tension: 0.2, yAxisID: 'y' },
          { label: '成交量', data: data.chart.volumes, borderColor: '#f59e0b', yAxisID: 'y1' }
        ]
      },
      options: { responsive: true, scales: { y: { position: 'left' }, y1: { position: 'right', grid: { drawOnChartArea: false } } } }
    });
  }, [data?.chart]);

  return (
    <div className="max-w-7xl mx-auto p-4 space-y-6">
      <h1 className="text-2xl font-bold flex items-center gap-2">
        LIVIA PRO <span className="text-sm text-gray-500">实时链上检测</span>
      </h1>

      {/* 输入区 */}
      <div className="bg-white p-4 rounded-lg shadow flex flex-wrap gap-3">
        <select value={chain} onChange={e=>setChain(e.target.value)} className="px-3 py-2 border rounded">
          {Object.entries(CHAINS).map(([k,v])=><option key={k} value={k}>{v.name}</option>)}
        </select>
        <input value={contract} onChange={e=>setContract(e.target.value)} placeholder="0x..." className="flex-1 min-w-[300px] px-3 py-2 border rounded"/>
        <button onClick={fetchAll} disabled={loading} className="px-6 py-2 bg-gradient-to-r from-emerald-500 to-teal-600 text-white rounded disabled:opacity-50">
          {loading ? '加载中...' : '立即检测'}
        </button>
      </div>

      {error && <div className="bg-red-50 text-red-700 p-3 rounded">{error}</div>}

      {data && (
        <>
          {/* 概览卡片 */}
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <Card title="代币" value={`${data.info.name} (${data.info.symbol})`} />
            <Card title="总供应" value={Number(data.info.totalSupply).toLocaleString()} />
            <Card title="持有人" value={data.info.holders?.toLocaleString() || '—'} />
            <Card title="风险评分" value={data.risk} badge={data.risk>=70?'高':data.risk>=40?'中':'低'} />
          </div>

          {/* 价格图表 */}
          <div className="bg-white p-4 rounded-lg shadow">
            <h2 className="font-semibold mb-2">价格 & 成交量 (DexScreener)</h2>
            <canvas id="priceChart" height="100"></canvas>
          </div>

          {/* 持仓榜 */}
          <div className="bg-white p-4 rounded-lg shadow overflow-x-auto">
            <div className="flex justify-between mb-2">
              <h2 className="font-semibold">持仓 Top 100</h2>
              <button onClick={()=>{
                const csv = ['排名,地址,余额,占比'].concat(holders.map((h,i)=>`${i+1},${h.address},${h.balance},${h.percent}`)).join('\n');
                download(csv, 'holders.csv', 'text/csv');
              }} className="text-sm text-blue-600">导出 CSV</button>
            </div>
            <table {...table.getTableProps()} className="w-full text-sm">
              <thead className="bg-gray-50">
                {table.headerGroups.map(headerGroup => (
                  <tr {...headerGroup.getHeaderGroupProps()}>
                    {headerGroup.headers.map(column => (
                      <th {...column.getHeaderProps(column.getSortByToggleProps())} className="px-3 py-2 text-left">
                        {column.render('Header')}
                        {column.isSorted ? (column.isSortedDesc ? ' ↓' : ' ↑') : ''}
                      </th>
                    ))}
                  </tr>
                ))}
              </thead>
              <tbody {...table.getTableBodyProps()}>
                {table.page.map(row => {
                  table.prepareRow(row);
                  return (
                    <tr {...row.getRowProps()} className={row.original.isWhale?'whale':''}>
                      {row.cells.map(cell => <td {...cell.getCellProps()} className="px-3 py-1 border-t">{cell.render('Cell')}</td>)}
                    </tr>
                  );
                })}
              </tbody>
            </table>
            <div className="flex justify-between mt-2 text-sm">
              <button onClick={()=>table.previousPage()} disabled={!table.canPreviousPage} className="px-2 disabled:opacity-50">上一页</button>
              <span>第 {table.state.pageIndex + 1} 页 / 共 {table.pageOptions.length}</span>
              <button onClick={()=>table.nextPage()} disabled={!table.canNextPage} className="px-2 disabled:opacity-50">下一页</button>
            </div>
          </div>

          {/* LP 锁仓 */}
          <div className="bg-white p-4 rounded-lg shadow">
            <h2 className="font-semibold mb-2">LP 流动性检测</h2>
            {data.lp?.length ? (
              <div className="space-y-2">
                {data.lp.map(p=><div key={p.pair} className="flex justify-between text-sm">
                  <span>{p.dex} • {p.pair}</span>
                  <span className={p.locked?'text-green-600':'text-red-600'}>
                    {p.locked ? '已锁定' : '未锁定'} ({(p.percent*100).toFixed(1)}%)
                  </span>
                </div>)}
              </div>
            ) : <p className="text-gray-500">未检测到 LP</p>}
          </div>
        </>
      )}
    </div>
  );
}

// 小组件
function Card({title, value, badge}) {
  return (
    <div className="bg-white p-4 rounded-lg shadow">
      <div className="text-xs text-gray-500">{title}</div>
      <div className="text-lg font-semibold">{value}</div>
      {badge && <span className={`inline-block mt-1 px-2 py-0.5 text-xs rounded-full ${badge==='高'?'bg-red-100 text-red-700':badge==='中'?'bg-yellow-100 text-yellow-700':'bg-green-100 text-green-700'}`}>{badge}</span>}
    </div>
  );
}

function download(data, filename, type) {
  const blob = new Blob([data], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>LIVIA åˆ†æå¹³å° ç§»åŠ¨ç‰ˆ</title>
    <meta name="description" content="LIVIA DeFi åˆ†æï¼Œæ”¯æŒ BSC/ETH/Solana">
    <meta name="theme-color" content="#0af">
    <style>
        body { background: #111; color: #fff; font-family: Arial, sans-serif; margin: 0; padding: 8px; font-size: 14px; }
        .container { max-width: 100%; padding: 8px; }
        h2 { margin: 8px 0; font-size: 16px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin: 8px 0; }
        th, td { border: 1px solid #555; padding: 4px; text-align: center; }
        th { background: #222; }
        .whale { background: #ff0; color: #000; }
        .red { color: #f00; }
        .green { color: #0f0; }
        input, select, button { width: 100%; padding: 6px; margin: 4px 0; border: 1px solid #555; border-radius: 4px; font-size: 12px; background: #111; color: #fff; box-sizing: border-box; }
        button { background: #0af; cursor: pointer; }
        .error { color: #f00; font-size: 12px; padding: 4px; background: rgba(255,0,0,0.1); border-radius: 4px; margin: 4px 0; display: none; }
        #loading { display: none; text-align: center; color: #0af; font-size: 12px; margin: 8px 0; }
        #progressBar { background: #222; height: 4px; border-radius: 2px; margin: 4px 0; overflow: hidden; display: none; }
        #progressFill { background: #0af; height: 100%; width: 0%; transition: width .3s; }
        #riskWarning { color: #f00; font-size: 12px; margin: 8px 0; padding: 4px; background: rgba(255,0,0,0.1); border-radius: 4px; display: none; }
        .chart-container { width: 100%; height: 100px; margin: 8px 0; position: relative; background: #222; border-radius: 4px; padding: 8px; }
        .chart-export { position: absolute; top: 4px; right: 4px; background: #0af; color: #111; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; border: none; }
        .no-data { text-align: center; color: #ccc; margin: 8px 0; }
        @media (max-width: 600px) { table { font-size: 10px; } .chart-container { height: 80px; padding: 4px; } }
    </style>
</head>
<body>
    <div class="container">
        <h2>LIVIA åˆ†æå¹³å° ç§»åŠ¨ç‰ˆ</h2>
        <select id="chainSelect">
            <option value="BSC">BSC</option>
            <option value="ETH">ETH</option>
            <option value="Solana">Solana</option>
        </select>
        <input id="tokenInput" placeholder="åˆçº¦åœ°å€ (e.g. 0x55d398326f99059fF775485246999027B3197955)">
        <input id="apiKeyInput" placeholder="API Key (bscscan.com/apiså…è´¹ï¼ŒSolanaå¯é€‰)" type="password">
        <button id="analyzeBtn">ğŸš€ åˆ†æ</button>
        <div id="errorMsg" class="error"></div>
        <div id="loading">åˆ†æä¸­...</div>
        <div id="progressBar"><div id="progressFill"></div></div>
        <div id="riskWarning"></div>
        <div id="holdersTable" class="no-data">ç‚¹å‡»â€œåˆ†æâ€åŠ è½½æŒæœ‰äººæ•°æ®</div>
        <div class="chart-container">
            <canvas id="priceChart" width="300" height="100"></canvas>
            <button class="chart-export" onclick="alert('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­')">ğŸ“Š å¯¼å‡ºå›¾è¡¨</button>
        </div>
    </div>
    <script>
        console.log('LIVIA ç»ˆæç‰ˆå¯åŠ¨ - è¡¨å•å·²æ¸²æŸ“');
        const CHAIN_CONFIG = {
            BSC: { apiBase: "https://api.bscscan.com/api", decimals: 18, scan: "bscscan.com", holderEndpoint: "?module=token&action=tokenholderlist&contractaddress=", supplyEndpoint: "?module=stats&action=tokensupply&contractaddress=" },
            ETH: { apiBase: "https://api.etherscan.io/api", decimals: 18, scan: "etherscan.io", holderEndpoint: "?module=token&action=tokenholderlist&contractaddress=", supplyEndpoint: "?module=stats&action=tokensupply&contractaddress=" },
            Solana: { apiBase: "https://public-api.solscan.io", decimals: 9, scan: "solscan.io", holderEndpoint: "/token/holders?tokenAddress=", supplyEndpoint: "/token/meta?tokenAddress=" }
        };

        document.getElementById('analyzeBtn').onclick = async () => {
            const chainSelect = document.getElementById('chainSelect');
            const tokenInput = document.getElementById('tokenInput');
            const apiKeyInput = document.getElementById('apiKeyInput');
            const errorMsg = document.getElementById('errorMsg');
            const loading = document.getElementById('loading');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const riskWarning = document.getElementById('riskWarning');
            const holdersTable = document.getElementById('holdersTable');

            const chain = chainSelect.value;
            const address = tokenInput.value.trim();
            const apiKey = apiKeyInput.value.trim();

            console.log('åˆ†æå¯åŠ¨:', { chain, address, apiKey: apiKey ? 'æœ‰' : 'æ— ' });

            // éªŒè¯
            errorMsg.style.display = 'none';
            riskWarning.style.display = 'none';
            if (!address) {
                errorMsg.textContent = 'è¯·è¾“å…¥åˆçº¦åœ°å€';
                errorMsg.style.display = 'block';
                return;
            }
            if (chain !== 'Solana' && !apiKey) {
                errorMsg.textContent = 'è¯·è¾“å…¥API Key (Solanaå¯é€‰)';
                errorMsg.style.display = 'block';
                return;
            }
            if (chain !== 'Solana' && !/^0x[a-fA-F0-9]{40}$/.test(address)) {
                errorMsg.textContent = 'æ— æ•ˆåˆçº¦åœ°å€';
                errorMsg.style.display = 'block';
                return;
            }

            // åŠ è½½UI
            loading.style.display = 'block';
            progressBar.style.display = 'block';
            progressFill.style.width = '30%';
            document.getElementById('analyzeBtn').disabled = true;
            holdersTable.innerHTML = '<p style="text-align:center; color:#0af;">è·å–æ•°æ®ä¸­...</p>';

            try {
                const config = CHAIN_CONFIG[chain];
                let supply = 0;
                // ä¾›åº”é‡
                if (chain === 'Solana') {
                    const res = await fetch(`${config.apiBase}${config.supplyEndpoint}${address}`);
                    const data = await res.json();
                    supply = data.data ? parseFloat(data.data.supply) / Math.pow(10, config.decimals) : 0;
                } else {
                    const res = await fetch(`${config.apiBase}${config.supplyEndpoint}${address}&apikey=${apiKey}`);
                    const data = await res.json();
                    supply = data.status === '1' ? parseFloat(data.result) / Math.pow(10, config.decimals) : 0;
                }
                progressFill.style.width = '60%';
                console.log('ä¾›åº”é‡:', supply);

                // æŒæœ‰äºº
                let holdersData = [];
                if (chain === 'Solana') {
                    const res = await fetch(`${config.apiBase}${config.holderEndpoint}${address}&offset=0&limit=10`);
                    const data = await res.json();
                    holdersData = data.data ? data.data.map(h => ({ address: h.owner, balance: parseFloat(h.amount || 0) / Math.pow(10, config.decimals) })) : [];
                } else {
                    const res = await fetch(`${config.apiBase}${config.holderEndpoint}${address}&page=1&offset=1&limit=10&apikey=${apiKey}`);
                    const data = await res.json();
                    holdersData = data.status === '1' && data.result ? data.result.map(h => ({ address: h.TokenHolder.Address, balance: parseFloat(h.TokenHolder.Quantity || 0) / Math.pow(10, config.decimals) })) : [];
                }
                const topHolders = holdersData.sort((a, b) => b.balance - a.balance).slice(0, 10);
                progressFill.style.width = '100%';
                console.log('æŒæœ‰äºº:', topHolders.length);

                // è¡¨æ ¼
                if (topHolders.length) {
                    let tableHTML = '<table><thead><tr><th>åœ°å€</th><th>æŒä»“</th><th>å æ¯”</th><th>é²¸é±¼ (>1%)</th><th>é£é™©</th></tr></thead><tbody>';
                    topHolders.forEach(h => {
                        const pct = supply > 0 ? (h.balance / supply * 100).toFixed(2) : '0.00';
                        const isWhale = parseFloat(pct) > 1;
                        const risk = parseFloat(pct) > 50 ? 'é«˜' : 'ä½';
                        tableHTML += `<tr class="${isWhale ? 'whale' : ''}"><td><a href="https://${config.scan}/address/${h.address}" target="_blank">${h.address.slice(0,6)}...${h.address.slice(-4)}</a></td><td>${h.balance.toFixed(0)}</td><td>${pct}%</td><td>${isWhale ? 'Yes' : 'No'}</td><td class="${risk === 'é«˜' ? 'red' : 'green'}">${risk}</td></tr>`;
                    });
                    tableHTML += '</tbody></table>';
                    holdersTable.innerHTML = tableHTML;
                } else {
                    holdersTable.innerHTML = '<p class="no-data">æ— æŒæœ‰äººæ•°æ®</p>';
                }

                // é£é™©
                if (topHolders.length && supply > 0) {
                    const ratio = topHolders.reduce((sum, h) => sum + h.balance, 0) / supply * 100;
                    if (ratio > 50) {
                        riskWarning.textContent = `å‰10åœ°å€æŒä»“å æ¯” ${ratio.toFixed(2)}%ï¼Œè¿‡é«˜ï¼Œå¯èƒ½ä¸ºè²”è²…ç›˜`;
                        riskWarning.style.display = 'block';
                    }
                }
            } catch (err) {
                console.error('é”™è¯¯:', err);
                errorMsg.textContent = `åŠ è½½å¤±è´¥: ${err.message}`;
                errorMsg.style.display = 'block';
                holdersTable.innerHTML = '<p class="no-data">åŠ è½½å‡ºé”™ï¼Œè¯·æ£€æŸ¥API Keyæˆ–ç½‘ç»œ</p>';
            } finally {
                loading.style.display = 'none';
                progressBar.style.display = 'none';
                document.getElementById('analyzeBtn').disabled = false;
            }
        };
    </script>
</body>
</html>
